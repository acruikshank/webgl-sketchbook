<html>
  <head>
    <title>Grid</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style type="text/css">
      html, body { margin:0; width: 100%; height:100%; background: #333; }
      canvas {width: 100%; height: 100%; margin: 0; }
      video {display: none;}
    </style>
    <script src="sylvester.js" type="text/javascript"></script>
    <script src="glUtils.js" type="text/javascript"></script>
    <script src="sketchbook-util.js" type="text/javascript"></script>

    <script id="flat" type="x-shader/x-vertex">
      precision mediump float;

      attribute vec2 position;

      void main(void) {
        gl_Position = vec4(position, 0.0, 1.0);
      }
    </script>

    <script id="grid" type="x-shader/x-fragment">
      precision mediump float;

      uniform sampler2D video;
      uniform vec2 texelSize;
      uniform vec2 size;
      uniform float theta;

      void main(void) {
        float scale = 2880.0 / size.x;
        vec2 p = vec2(1.0) - texelSize * gl_FragCoord.st;
        vec2 center = size*.5;
        vec2 offset = gl_FragCoord.xy - center;
        float norm = length(offset);

        float shape = length((texture2D(video,p) * 41.0
          + (texture2D(video,p + texelSize*vec2(1.0,0.0))
          + texture2D(video,p + texelSize*vec2(-1.0,0.0))
          + texture2D(video,p + texelSize*vec2(0.0,-1.0))
          + texture2D(video,p + texelSize*vec2(0.0,1.0))) * 26.0
          + (texture2D(video,p + texelSize*vec2(-1.0))
          + texture2D(video,p + texelSize*vec2(-1.0,1.0))
          + texture2D(video,p + texelSize*vec2(1.0,-1.0))
          + texture2D(video,p + texelSize*vec2(1.0))) * 16.0
          + (texture2D(video,p + texelSize*vec2(2.0,0.0))
          + texture2D(video,p + texelSize*vec2(-2.0,0.0))
          + texture2D(video,p + texelSize*vec2(0.0,-2.0))
          + texture2D(video,p + texelSize*vec2(0.0,2.0))) * 7.0
          + (texture2D(video,p + texelSize*vec2(1.0,2.0))
          + texture2D(video,p + texelSize*vec2(-1.0,2.0))
          + texture2D(video,p + texelSize*vec2(2.0,-1.0))
          + texture2D(video,p + texelSize*vec2(2.0,1.0))) * 4.0
          + (texture2D(video,p + texelSize*vec2(1.0,-2.0))
          + texture2D(video,p + texelSize*vec2(-1.0,-2.0))
          + texture2D(video,p + texelSize*vec2(-2.0,-1.0))
          + texture2D(video,p + texelSize*vec2(-2.0,1.0))) * 4.0
          + (texture2D(video,p + texelSize*vec2(2.0,2.0))
          + texture2D(video,p + texelSize*vec2(-2.0,2.0))
          + texture2D(video,p + texelSize*vec2(2.0,-2.0))
          + texture2D(video,p + texelSize*vec2(-2.0,2.0))) * 1.0
        ).rgb) / 273.0;
        vec2 mapCoord = offset * mix(1.0,.7,shape);
        vec2 coord = sin(0.20 *mapCoord * scale + 80.0*theta);

        float light = 30.0*(max(0.0,max(coord.x, coord.y))-0.998 + .02*shape);

        gl_FragColor = vec4(vec3(light), 1.0);
        // gl_FragColor = 8.0*texture2D(video,p);
      }
    </script>
  </head>

  <body>
    <video id="v" autoplay width="480" height="360"></video>
    <canvas id="c"></canvas>
  </body>
  <script>
var canvas;
var gl;
var gridShader;
var coordAttribute;
var theta = 0;
var dTheta = .001;

var canvas = document.getElementById('c');
var gl = canvas.getContext("experimental-webgl");
var cw = canvas.width = canvas.offsetWidth * (window.devicePixelRatio||1);
var ch = canvas.height = canvas.offsetHeight * (window.devicePixelRatio||1);

SketchbookUtil.startWebcam(document.getElementById('v'), start);

function start() {

  if (gl) {
    gl.clearColor(0, 0, 0, 1.0);  // Clear to black, fully opaque

    gridShader = SketchbookUtil.createProgram(gl, 'flat', 'grid');

    render();
  }
}

function render() {
  var texture = gl.createTexture();
  gl.bindTexture(gl.TEXTURE_2D, texture);
  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, document.getElementById('v'));
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
  gl.bindTexture(gl.TEXTURE_2D, null);

  gl.useProgram(gridShader);


  gl.activeTexture(gl.TEXTURE0);
  gl.bindTexture(gl.TEXTURE_2D, texture);
  gl.uniform1i(gl.getUniformLocation(gridShader, "video"), 0);
  gl.uniform2f(gl.getUniformLocation(gridShader, "size"), canvas.width, canvas.height);
  gl.uniform1f(gl.getUniformLocation(gridShader, "theta"), theta);
  gl.uniform2f(gl.getUniformLocation(gridShader, "texelSize"), 1/(canvas.width), 1/(canvas.height));


  gl.bindFramebuffer(gl.FRAMEBUFFER, null);
  gl.viewport(0, 0, canvas.width, canvas.height);
  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
  SketchbookUtil.drawFlatBackground(gl, gridShader);

  theta += dTheta;
  requestAnimationFrame(render);
}

  </script>
</html>
